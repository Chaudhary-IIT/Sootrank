{% extends "student_base.html" %}

{% block title %}Fee Payment | Sootrank{% endblock %}
{% block nav_quick_links_active %} active{% endblock %}

{% block content %}

<style>
  /* Page-local styles */
  .page-title { color:#2469f0; font-weight:700; text-align:center; margin-top:6px; }
  .card { border:0; border-radius:12px; box-shadow:0 5px 20px rgba(0,0,0,0.08); }
  .btn-pay { background:#2469f0; color:white; font-weight:600; border-radius:10px; }
  .btn-pay:hover { background:#1a52d1; }
  .modal-content { border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,0.15); }
  .modal-header { background:#2469f0; color:white; border-top-left-radius:18px; border-top-right-radius:18px; }
</style>

<h2 class="page-title">Fee Details</h2>

<!-- Summary -->
<div class="alert alert-info text-center mt-3">
  <strong>Total Due:</strong> ‚Çπ{{ total_due }} &nbsp;&nbsp; | &nbsp;&nbsp;
  <strong>Total Paid:</strong> ‚Çπ{{ total_paid }}
</div>

<!-- Pending Fees -->
<div class="card p-4 mb-4">
  <h5 class="mb-3 text-primary">‚è≥ Pending Fees</h5>
  {% if due_fees %}
  <div class="table-responsive">
    <table class="table table-striped align-middle text-center">
      <thead>
        <tr><th>Semester</th><th>Amount Due</th><th>Status</th><th>Action</th></tr>
      </thead>
      <tbody>
      {% for f in due_fees %}
        <tr>
          <td>{{ f.semester }}</td>
          <td>‚Çπ{{ f.amount_due }}</td>
          <td><span class="badge bg-warning text-dark">{{ f.status }}</span></td>
          <td>
            <button
              class="btn btn-pay"
              onclick="openPaymentModal('{{ f.id }}', '{{ f.amount_due }}', '{% url 'fees_pay' f.id %}')">
              Pay Now
            </button>
          </td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-muted mb-0">üéâ No dues ‚Äî all fees cleared.</p>
  {% endif %}
</div>

<!-- Paid Fees -->
<div class="card p-4">
  <h5 class="mb-3 text-success">‚úÖ Paid Fees</h5>
  {% if paid_fees %}
  <div class="table-responsive">
    <table class="table table-striped align-middle text-center">
      <thead><tr><th>Semester</th><th>Amount Paid</th><th>Date</th><th>Receipt</th></tr></thead>
      <tbody>
      {% for f in paid_fees %}
        <tr>
          <td>{{ f.semester }}</td>
          <td>‚Çπ{{ f.amount_paid }}</td>
          <td>{{ f.payment_time|date:"d M Y, h:i A" }}</td>
          <td><a href="{% url 'download_fee_receipt' f.id %}" class="btn btn-outline-primary btn-sm">Download</a></td>
        </tr>
      {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="text-muted mb-0">No payment history yet.</p>
  {% endif %}
</div>

<!-- Modal -->
<div class="modal fade" id="paymentModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Secure Payment</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <h6 class="text-muted mb-3">Sootrank Fee Payment Gateway</h6>
        <h4 class="text-primary mb-4">‚Çπ<span id="payAmount"></span></h4>
        <button id="confirmPay" class="btn btn-pay w-100">Confirm Payment</button>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block script %}
<script>
  let currentPayUrl = null;

  function openPaymentModal(feeId, amount, payUrl) {
    currentPayUrl = payUrl;
    document.getElementById("payAmount").innerText = amount;
    const modal = new bootstrap.Modal(document.getElementById('paymentModal'));
    modal.show();
  }

  document.getElementById("confirmPay").addEventListener("click", function() {
    if (!currentPayUrl) return;
    fetch(currentPayUrl)
      .then(r => r.json())
      .then(data => {
        alert(data.message || "Payment processed.");
        if (data.redirect) {
          window.location.href = data.redirect;
        } else {
          window.location.reload();
        }
      })
      .catch(() => alert("Error while processing payment."));
  });
</script>
{% endblock %}
