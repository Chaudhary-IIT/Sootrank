{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Central Timetable Management - Sootrank Admin</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    /* ==== THEME (shared across admin) ==== */
    :root{
      --color-primary: #34495e;   /* navbar / headings */
      --color-accent:  #3498db;   /* focus / primary */
      --color-bg:      #f4f6f8;   /* app background */
      --color-surface: #ffffff;   /* cards/tables */
      --color-text:    #2c3e50;   /* main text */
      --color-muted:   #7f8c8d;   /* muted text */
      --border:        #e6ecf1;   /* light borders */
      --radius:        12px;
      --shadow-subtle: 0 2px 8px rgba(0,0,0,0.06);
      --shadow-hover:  0 10px 20px rgba(52,152,219,0.12);
      --container-max: 1140px;
    }

    body { background-color: var(--color-bg); color: var(--color-text); font-family: "Segoe UI", Roboto, Arial, sans-serif; }
    .text-primary{ color: var(--color-primary) !important; }

    /* Navbar */
    .navbar-dark.bg-primary{
      background: linear-gradient(180deg, var(--color-primary), #2f4252) !important;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      min-height: 64px;
    }
    .navbar-brand{ font-weight: 700; font-size: 1.15rem; }

    /* Card shell */
    .card-surface{
      background: var(--color-surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow-subtle);
    }
    .card-surface:hover{ box-shadow: var(--shadow-hover); transition: box-shadow .2s ease; }

    .form-control, .form-select{
      border-color: var(--border);
      border-radius: 10px;
    }
    .form-control:focus, .form-select:focus{
      border-color: var(--color-accent);
      box-shadow: 0 0 0 .2rem rgba(52,152,219,.15);
    }

    .btn-primary{
      background-color: var(--color-accent) !important;
      border-color: var(--color-accent) !important;
      box-shadow: var(--shadow-subtle);
    }
    .btn-primary:hover{ filter: brightness(.98); box-shadow: var(--shadow-hover); }

    .btn-outline-light{ box-shadow: var(--shadow-subtle); }
    .btn-outline-light:hover{ box-shadow: var(--shadow-hover); }

    .table thead.table-primary{
      --bs-table-color: #fff;
      --bs-table-bg: #3a7db3;
      --bs-table-border-color: #3a7db3;
    }

    .course-row{ border-top: 1px solid var(--border); }
    .muted{ color: var(--color-muted); }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-primary shadow-sm mb-4">
    <div class="container">
      <a class="navbar-brand" href="{% url 'custom_admin_home' %}">Sootrank Admin</a>
      <div class="ms-auto">
        <a href="{% url 'custom_admin_home' %}" class="btn btn-outline-light btn-sm">
          <i class="fa-solid fa-arrow-left me-1"></i> Back
        </a>
      </div>
    </div>
  </nav>

  <div class="container" style="max-width: var(--container-max);">
    {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Header + Search -->
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-md-between mb-3">
      <div>
        <h2 class="mb-1 text-primary">Central Timetable Management</h2>
        <div class="muted">View, add, and edit timetable slots for all courses</div>
      </div>
      <div class="mt-3 mt-md-0" style="min-width: 280px;">
        <div class="input-group">
          <span class="input-group-text"><i class="fa fa-search"></i></span>
          <input type="text" id="searchInput" onkeyup="filterCourses()" class="form-control" placeholder="Search courses...">
        </div>
      </div>
    </div>

    <!-- Course list -->
    <div class="card-surface p-3 p-md-4">
      {% if courses %}
        <div id="courseList">
          {% for course in courses %}
            <div class="py-3 course-row"
                 data-name="{{ course.code }} {{ course.name }}"
                 data-timetable-count="{{ course.timetables.all.count }}">
              <div class="d-flex align-items-center justify-content-between">
                <div>
                  <h5 class="mb-1">
                    <button class="btn btn-link p-0 text-decoration-none text-primary"
                            onclick="toggleTimetable('{{ course.id }}')">
                      {{ course.code }} — {{ course.name }}
                    </button>
                  </h5>
                  <div class="small muted">
                    Faculty:
                    {% for f in course.faculties.all %}
                      {{ f.first_name }} {{ f.last_name }}{% if not forloop.last %}, {% endif %}
                    {% empty %}
                      —
                    {% endfor %}
                  </div>
                </div>
                <button class="btn btn-success btn-sm"
                        onclick="openAddModal('{{ course.id }}', '{{ course.code|escapejs }} - {{ course.name|escapejs }}')">
                  <i class="fa fa-plus me-1"></i> Add Slot
                </button>
              </div>

              <!-- Timetable table (hidden by default) -->
              <div id="timetable-{{ course.id }}" class="mt-3" style="display:none;">
                {% with slots=course.timetables.all %}
                  {% if slots %}
                    <div class="table-responsive">
                      <table class="table table-sm align-middle mb-0">
                        <thead class="table-primary">
                          <tr>
                            <th>Day</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Location</th>
                            <th>Remarks</th>
                            <th class="text-center">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for t in slots %}
                            <tr>
                              <td>{{ t.day }}</td>
                              <td>{{ t.start_time|time:'H:i' }}</td>
                              <td>{{ t.end_time|time:'H:i' }}</td>
                              <td>{{ t.location|default:"—" }}</td>
                              <td>{{ t.remarks|default:"—" }}</td>
                              <td class="text-center">
                                <button class="btn btn-link btn-sm text-decoration-none"
                                        onclick="openEditModal(
                                          '{{ t.id }}',
                                          '{{ course.code|escapejs }} - {{ course.name|escapejs }}',
                                          '{{ t.day|escapejs }}',
                                          '{{ t.start_time|time:'H:i' }}',
                                          '{{ t.end_time|time:'H:i' }}',
                                          '{{ t.location|default_if_none:''|escapejs }}',
                                          '{{ t.remarks|default_if_none:''|escapejs }}'
                                        )">
                                  <i class="fa fa-pen me-1"></i> Edit
                                </button>
                                <a href="{% url 'admin_timetable_delete' t.id %}"
                                   class="btn btn-link btn-sm text-danger text-decoration-none">
                                  <i class="fa fa-trash me-1"></i> Delete
                                </a>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <div class="fst-italic text-muted">No slots yet for this course.</div>
                  {% endif %}
                {% endwith %}
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="text-muted">No courses found.</div>
      {% endif %}
    </div>
  </div>

  <!-- Add Modal -->
  <div class="modal fade" id="addModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="post" action="{% url 'admin_timetable_add' %}">
          {% csrf_token %}
          <div class="modal-header bg-light">
            <h5 class="modal-title">Add Timetable Slot</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <input type="hidden" name="course" id="addCourseId">
            <div class="mb-3">
              <label class="form-label">Course</label>
              <input type="text" id="addCourseName" readonly class="form-control bg-light">
            </div>
            <div class="mb-3">
              <label class="form-label">Day</label>
              <select name="day" required class="form-select">
                {% for d, label in days %}
                  <option value="{{ d }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Start Time</label>
                <input type="time" name="start_time" required class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">End Time</label>
                <input type="time" name="end_time" required class="form-control">
              </div>
            </div>
            <div class="row g-3 mt-0">
              <div class="col-md-6">
                <label class="form-label">Location</label>
                <input type="text" name="location" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Remarks</label>
                <input type="text" name="remarks" class="form-control">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-success">Add Slot</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="post" id="editForm">
          {% csrf_token %}
          <div class="modal-header bg-light">
            <h5 class="modal-title">Edit Timetable Slot</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <span class="small text-muted">Course</span>
              <div class="fw-semibold" id="editCourseName"></div>
            </div>
            <div class="mb-3">
              <label class="form-label">Day</label>
              <select name="day" id="editDay" required class="form-select">
                {% for d, label in days %}
                  <option value="{{ d }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="row g-3">
              <div class="col-md-6">
                <label class="form-label">Start Time</label>
                <input type="time" name="start_time" id="editStart" required class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">End Time</label>
                <input type="time" name="end_time" id="editEnd" required class="form-control">
              </div>
            </div>
            <div class="row g-3 mt-0">
              <div class="col-md-6">
                <label class="form-label">Location</label>
                <input type="text" name="location" id="editLocation" class="form-control">
              </div>
              <div class="col-md-6">
                <label class="form-label">Remarks</label>
                <input type="text" name="remarks" id="editRemarks" class="form-control">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    setTimeout(function () {
            document.querySelectorAll('.alert').forEach(function (alert) {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 4000);
    // Expand/collapse a course table (single open at a time)
    function toggleTimetable(courseId) {
      document.querySelectorAll('[id^="timetable-"]').forEach(el => {
        el.style.display = (el.id === `timetable-${courseId}` && el.style.display !== 'block') ? 'block' : 'none';
      });
    }

    // Search filter
    function filterCourses() {
      const q = (document.getElementById('searchInput').value || '').toLowerCase();
      document.querySelectorAll('#courseList .course-row').forEach(row => {
        const name = (row.getAttribute('data-name') || '').toLowerCase();
        row.style.display = name.includes(q) ? '' : 'none';
      });
    }

    // Auto-sort: courses with more slots rise to top
    document.addEventListener('DOMContentLoaded', () => {
      const container = document.getElementById('courseList');
      if (!container) return;
      const rows = Array.from(container.children);
      rows.sort((a, b) => (parseInt(b.dataset.timetableCount || '0', 10) - parseInt(a.dataset.timetableCount || '0', 10)));
      rows.forEach(r => container.appendChild(r));
    });

    // Add modal
    function openAddModal(courseId, courseName) {
      document.getElementById('addCourseId').value = courseId;
      document.getElementById('addCourseName').value = courseName;
      const m = new bootstrap.Modal(document.getElementById('addModal'));
      m.show();
    }

    // Edit modal
    function openEditModal(id, courseName, day, start, end, location, remarks) {
      document.getElementById('editForm').action = `/custom-admin/timetable/edit/${id}/`;
      document.getElementById('editCourseName').textContent = courseName;
      document.getElementById('editDay').value = day;
      document.getElementById('editStart').value = start;
      document.getElementById('editEnd').value = end;
      document.getElementById('editLocation').value = location || '';
      document.getElementById('editRemarks').value = remarks || '';
      const m = new bootstrap.Modal(document.getElementById('editModal'));
      m.show();
    }
  </script>
</body>
</html>
