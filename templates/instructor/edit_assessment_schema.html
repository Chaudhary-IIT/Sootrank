{% extends "faculty_base.html" %}

{% load static %}
{% load widget_tweaks %}

{% block title %}Assessment Scheme — {{ course.code }}{% endblock %}

{% block nav_courses_active %} active{% endblock %}

{% block content %}

<div class="mb-4 text-center">
  <h1 class="fs-3 fw-bold mb-1">Assessment Scheme</h1>
  <p class="text-muted small mb-0">
    {{ course.code }} — {{ course.name }}
  </p>
</div>

<div class="bg-white p-4 p-md-5 mb-4" style="border-radius: var(--radius); box-shadow: var(--shadow-subtle);">
  
  <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
    <div>
      <h2 class="fs-5 fw-semibold">Components</h2>
      <p class="text-muted small mb-0">Define components and ensure total weight equals 100.</p>
    </div>
    <div>
      <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill small">
        Total weight:
        <span id="totalWeight" class="fw-bold ms-1">—</span>%
      </span>
    </div>
  </div>

  <form method="post" class="mt-4">
    {% csrf_token %}
    {{ formset.management_form }}
    
    <div class="overflow-x-auto mb-3" style="border: 1px solid var(--border); border-radius: var(--radius);">
      <table class="table align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="p-3 small text-muted text-uppercase">Name</th>
            <th class="p-3 small text-muted text-uppercase">Weight (%)</th>
            <th class="p-3 small text-muted text-uppercase">Max Marks</th>
            <th class="p-3 small text-muted text-uppercase">Delete</th>
          </tr>
        </thead>
        <tbody>

          {% for form in formset %}
            <tr>
              <td class="p-3">
                {{ form.id }}
                {% for error in form.name.errors %}
                  <div class="text-danger small mb-1">{{ error }}</div>
                {% endfor %}
                {{ form.name|add_class:"form-control form-control-sm" }}
              </td>

              <td class="p-3" style="width: 130px;">
                {% for error in form.weight.errors %}
                  <div class="text-danger small mb-1">{{ error }}</div>
                {% endfor %}
                {{ form.weight|add_class:"form-control form-control-sm" }}
              </td>

              <td class="p-3" style="width: 130px;">
                {% for error in form.max_marks.errors %}
                  <div class="text-danger small mb-1">{{ error }}</div>
                {% endfor %}
                {{ form.max_marks|add_class:"form-control form-control-sm" }}
              </td>

              <td class="p-3" style="width: 100px;">
                {% if form.DELETE %}
                  <!-- Keep DELETE checkbox in DOM -->
                  <div style="display: none;">
                    {{ form.DELETE }}
                  </div>

                  <button type="button"
                          class="btn btn-outline-danger btn-sm"
                          onclick="
                            const del = this.closest('tr').querySelector('input[type=checkbox][name$=\'-DELETE\']');
                            if (del) {
                              del.checked = true;
                              this.closest('tr').style.opacity = '0.4';
                              this.closest('tr').style.pointerEvents = 'none';
                            }
                          ">
                    Remove
                  </button>
                {% endif %}
              </td>

            </tr>
          {% empty %}
            <tr>
              <td colspan="4" class="p-5 text-center text-muted">
                No components yet. Use the form below to add.
              </td>
            </tr>
          {% endfor %}

        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4 flex-wrap gap-2">
      <button type="submit" class="btn btn-primary">
        <i class="fa-solid fa-save me-1"></i> Save Scheme
      </button>
      <div class="text-muted small">
        CSV headers must match component names.
      </div>
    </div>

  </form>
</div>

<div class="bg-white p-4 p-md-5 mb-4" style="border-radius: var(--radius); box-shadow: var(--shadow-subtle);">
  <h3 class="fs-6 fw-semibold mb-3">Add a New Component</h3>

  <form method="post" class="row g-3 align-items-end">
    {% csrf_token %}
    <input type="hidden" name="intent" value="add">
    
    <div class="col-sm-5">
      <label class="form-label small fw-medium">Name</label>
      <input name="add_name" type="text" placeholder="e.g., Quiz 1" class="form-control" required />
    </div>
    <div class="col-sm-2">
      <label class="form-label small fw-medium">Weight %</label>
      <input name="add_weight" type="number" step="0.01" min="0" max="100" placeholder="Weight" class="form-control" required />
    </div>
    <div class="col-sm-2">
      <label class="form-label small fw-medium">Max Marks</label>
      <input name="add_max" type="number" step="0.01" min="1" placeholder="Max" class="form-control" value="100" />
    </div>
    <div class="col-sm-auto">
      <button type="submit" class="btn btn-dark w-100">
        <i class="fa-solid fa-plus me-1"></i> Add
      </button>
    </div>
  </form>
</div>

<div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
  <a href="{% url 'assign_grades_csv' course.code %}" class="btn btn-success">
    <i class="fa-solid fa-upload me-1"></i> Update Grading Policy
  </a>

  {% if sample_headers %}
    <div class="text-muted small">
      <strong>Sample Headers:</strong> {{ sample_headers|join:", " }}
    </div>
  {% endif %}
</div>

{% endblock %}

{% block extra_js %}
<script>
  function sumWeights() {
    const inputs = document.querySelectorAll("input[name$='-weight']:not([name*='__prefix__'])");
    let total = 0;

    inputs.forEach(i => {
      const row = i.closest('tr');
      if (row) {
        const del = row.querySelector("input[type=checkbox][name$='-DELETE']");
        if (del && del.checked) return;
      }
      const v = parseFloat(i.value);
      if (!isNaN(v)) total += v;
    });

    const el = document.getElementById('totalWeight');
    if (el) {
      el.textContent = (Math.round(total * 100) / 100).toFixed(2);
      const badge = el.closest('.badge');

      if (badge) {
        badge.classList.remove('bg-success-subtle', 'text-success-emphasis',
                               'bg-danger-subtle', 'text-danger-emphasis',
                               'bg-secondary-subtle', 'text-secondary-emphasis');
        if (total === 100) {
          badge.classList.add('bg-success-subtle', 'text-success-emphasis');
        } else if (total > 100) {
          badge.classList.add('bg-danger-subtle', 'text-danger-emphasis');
        } else {
          badge.classList.add('bg-secondary-subtle', 'text-secondary-emphasis');
        }
      }
    }
  }

  document.addEventListener('input', e => {
    if (e.target.name && e.target.name.endsWith('-weight')) sumWeights();
  });

  document.addEventListener('DOMContentLoaded', sumWeights);
</script>
{% endblock %}
