{% extends "faculty_base.html" %}
{% block title %}Grades — {{ course.code }}{% endblock %}
{% block nav_results_active %} active{% endblock %}

{% block content %}
<div class="text-center mb-4">
  <h1 class="fs-3 fw-bold mb-1">Grades</h1>
  <p class="text-muted small mb-0">{{ course.code }} — {{ course.name }}</p>
</div>

{% if policy %}
<div class="alert alert-info small text-start mb-3">
  <i class="fa-solid fa-scale-balanced me-1"></i>
  Current Grading Mode: <strong>{{ policy.mode|title }}</strong>
</div>
{% endif %}

<div class="d-flex flex-column flex-sm-row gap-2 mb-3">
  <a href="?sort=asc" class="btn btn-sm btn-outline-secondary {% if sort_order == 'asc' %}active{% endif %}">
    <i class="fa-solid fa-arrow-up-a-z me-1"></i> Sort A → F
  </a>
  <a href="?sort=desc" class="btn btn-sm btn-outline-secondary {% if sort_order == 'desc' %}active{% endif %}">
    <i class="fa-solid fa-arrow-down-z-a me-1"></i> Sort F → A
  </a>
</div>

<div class="card overflow-hidden">
  <div class="table-responsive">
    <table class="table table-striped table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th class="p-3">Roll No</th>
          <th class="p-3">Student Name</th>
          <th class="p-3">Mode</th>
          <th class="p-3">Grade</th>
          <th class="p-3">Outcome</th>
        </tr>
      </thead>
      <tbody id="gradeTable">
        {% for res in results %}
        <tr data-student-id="{{ res.student.id }}">
          <td class="p-3 fw-medium mono">{{ res.student.roll_no|upper }}</td>
          <td class="p-3">{{ res.student.first_name }} {{ res.student.last_name }}</td>

          <td class="p-3">
            <span class="badge bg-secondary-subtle text-secondary-emphasis">{{ res.mode|title }}</span>
          </td>

          <td class="p-3 editable">
            <span class="grade-text">{{ res.grade }}</span>
          </td>

          <td class="p-3 editable">
            <span class="outcome-text">{{ res.outcome }}</span>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center text-muted p-5">No grades found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<script>
function getCookie(name){
  let cookieValue = null;
  if (document.cookie && document.cookie !== ""){
    const cookies = document.cookie.split(";");
    for (let cookie of cookies){
      cookie = cookie.trim();
      if (cookie.startsWith(name + "=")){
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// --- CHANGED: Added Event Delegation for Clicks ---
// This one listener on the table body handles all clicks for editing.
document.addEventListener("DOMContentLoaded", function() {
  const tableBody = document.getElementById("gradeTable");
  
  if (tableBody) {
    tableBody.addEventListener("click", function(e) {
      // Check if we are already editing this cell's parent
      if (e.target.closest("td")?.classList.contains("editing")) {
        return;
      }

      // Check if we clicked on the text span inside an editable cell
      if (e.target.classList.contains("grade-text")) {
        startGradeEdit(e.target.closest("td"));
      } else if (e.target.classList.contains("outcome-text")) {
        startOutcomeEdit(e.target.closest("td"));
      }
    });
  }
});


// --- Grade Edit ---
function startGradeEdit(td){
  if (!td) return;
  td.classList.add("editing"); // Mark as editing
  const tr = td.closest("tr");
  const studentId = tr.dataset.studentId;
  const oldVal = td.innerText.trim();
  const input = document.createElement("input");
  input.type = "text";
  input.className = "form-control form-control-sm";
  input.value = oldVal;
  td.innerHTML = "";
  td.appendChild(input);
  input.focus();

  input.addEventListener("blur", function(){
    td.classList.remove("editing"); // No longer editing
    const newVal = input.value.trim();
    if (newVal === oldVal) {
      td.innerHTML = `<span class='grade-text'>${oldVal}</span>`;
      return;
    }
    updateGradeOrOutcome(studentId, "grade", newVal, td, oldVal);
  });
}

// --- Outcome Dropdown Edit ---
function startOutcomeEdit(td){
  if (!td) return;
  td.classList.add("editing"); // Mark as editing
  const tr = td.closest("tr");
  const studentId = tr.dataset.studentId;
  const oldVal = td.innerText.trim();

  const select = document.createElement("select");
  select.className = "form-select form-select-sm";
  const options = ["Pass", "Fail", "FS"];
  for (const opt of options){
    const o = document.createElement("option");
    o.value = opt;
    o.text = opt;
    if (opt.toLowerCase() === oldVal.toLowerCase()) o.selected = true;
    select.appendChild(o);
  }

  td.innerHTML = "";
  td.appendChild(select);
  select.focus();

  // This single 'blur' event listener is correct.
  // It fires when the user clicks away OR when they select an item (closing the dropdown).
  select.addEventListener("blur", function(){
    td.classList.remove("editing"); // No longer editing
    const newVal = select.value.trim();
    if (newVal === oldVal){
      td.innerHTML = `<span class='outcome-text'>${oldVal}</span>`;
      return;
    }
    updateGradeOrOutcome(studentId, "outcome", newVal, td, oldVal);
  });
}

function updateGradeOrOutcome(studentId, field, newVal, td, oldVal){
  const formData = new FormData();
  formData.append("student_id", studentId);
  formData.append(field, newVal);

  fetch("{% url 'update_student_grade' course.code %}", {
    method: "POST",
    headers: {"X-CSRFToken": getCookie("csrftoken")},
    body: formData
  })
  .then(r=>r.json())
  .then(data=>{
    if (data.ok){
      td.innerHTML = `<span class='${field}-text'>${newVal}</span>`;
    } else {
      alert(data.error || "Update failed");
      td.innerHTML = `<span class='${field}-text'>${oldVal}</span>`;
    }
  })
  .catch(()=>{
    alert("Network error");
    td.innerHTML = `<span class='${field}-text'>${oldVal}</span>`;
  });
}
</script>
{% endblock %}