{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Assign Grades — {{ course.code }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="min-h-screen bg-gray-50">

<header class="bg-white shadow">
  <div class="max-w-5xl mx-auto px-4 py-4 flex items-center justify-between">
    <div>
      <h1 class="text-xl font-semibold">Assign Grades</h1>
      <p class="text-sm text-gray-600">{{ course.code }} — {{ course.name }}{% if semester %} · Semester {{ semester }}{% endif %}</p>
    </div>
    <div class="flex items-center gap-3">
      <a href="{% url 'edit_assessment_scheme' course.code %}?sem={{ semester }}" class="text-sm text-blue-700 hover:underline">Edit scheme</a>
      <a href="{% url 'view_schema_courses' %}" class="text-sm text-blue-700 hover:underline">Back to courses</a>
    </div>
  </div>
</header>

<main class="max-w-5xl mx-auto px-4 py-6">

  {% if messages %}
    <div class="space-y-2 mb-6">
      {% for message in messages %}
        <div class="rounded-md px-4 py-3 text-sm
          {% if message.tags == 'success' %} bg-green-50 text-green-800 border border-green-200
          {% elif message.tags == 'error' %} bg-red-50 text-red-800 border border-red-200
          {% elif message.tags == 'warning' %} bg-yellow-50 text-yellow-800 border border-yellow-200
          {% else %} bg-blue-50 text-blue-800 border border-blue-200 {% endif %}">
          {{ message }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Scheme -->
  <section class="bg-white rounded-xl shadow p-5 mb-6">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Assessment scheme</h2>
      {% if total_weight is not None %}
        <span class="text-sm text-gray-600">Total: <span class="font-medium">{{ total_weight }}%</span></span>
      {% endif %}
    </div>
    <div class="mt-3 overflow-x-auto">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">Component</th>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">Weight (%)</th>
            <th class="px-3 py-2 text-left text-xs font-medium text-gray-600 uppercase">Max Marks</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-100">
          {% for comp in components %}
            <tr>
              <td class="px-3 py-2 text-sm text-gray-900">{{ comp.name }}</td>
              <td class="px-3 py-2 text-sm text-gray-700">{{ comp.weight }}</td>
              <td class="px-3 py-2 text-sm text-gray-700">{{ comp.max_marks }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="3" class="px-3 py-4 text-center text-sm text-gray-500">No components defined.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <form method="post" enctype="multipart/form-data" class="space-y-6">
    {% csrf_token %}

    <!-- Scores file: CSV or Excel -->
    <section class="bg-white rounded-xl shadow p-5">
      <label class="block text-sm font-medium text-gray-700">Scores file (CSV or Excel)</label>
      <input type="file" name="csv_file"
             accept=".csv, text/csv, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, .xls, .xlsx"
             class="mt-1 rounded-md border border-gray-300 px-3 py-2 w-full" required>
      {% if sample_headers %}
        <p class="mt-2 text-xs text-gray-500">
          Required columns: roll_no and at least one component column ({{ sample_headers|join:", " }}).
          For Excel, use the first worksheet with a header row; headers are case-insensitive and ignore spaces/underscores.
        </p>
      {% endif %}
    </section>

    <!-- Grading mode -->
    <section class="bg-white rounded-xl shadow p-5">
      <label class="block text-sm font-medium text-gray-700 mb-2">Grading mode</label>
      <select name="mode" id="mode" class="rounded-md border-gray-300 text-sm px-3 py-2" onchange="togglePolicySections()">
        <option value="ABS" selected>Absolute (fixed cutoffs)</option>
        <option value="REL">Relative (percentile buckets)</option>
      </select>
    </section>

    <!-- Absolute -->
    <section id="absSection" class="bg-white rounded-xl shadow p-5">
      <h3 class="text-base font-semibold mb-3">Absolute cutoffs (percent)</h3>
      <div class="grid grid-cols-2 sm:grid-cols-6 gap-3">
        <div><label class="block text-xs text-gray-600 mb-1">A ≥</label><input name="abs_A" type="number" min="0" max="100" value="85" class="w-full rounded-md border-gray-300 text-sm px-3 py-2"></div>
        <div><label class="block text-xs text-gray-600 mb-1">A− ≥</label><input name="abs_B" type="number" min="0" max="100" value="75" class="w-full rounded-md border-gray-300 text-sm px-3 py-2"></div>
        <div><label class="block text-xs text-gray-600 mb-1">B ≥</label><input name="abs_C" type="number" min="0" max="100" value="65" class="w-full rounded-md border-gray-300 text-sm px-3 py-2"></div>
        <div><label class="block text-xs text-gray-600 mb-1">B− ≥</label><input name="abs_D" type="number" min="0" max="100" value="55" class="w-full rounded-md border-gray-300 text-sm px-3 py-2"></div>
        <div><label class="block text-xs text-gray-600 mb-1">C ≥</label><input name="abs_E" type="number" min="0" max="100" value="45" class="w-full rounded-md border-gray-300 text-sm px-3 py-2"></div>
        <div><label class="block text-xs text-gray-600 mb-1">Pass ≥</label><input name="pass_min_percent" type="number" min="0" max="100" value="45" class="w-full rounded-md border-gray-300 text-sm px-3 py-2"></div>
      </div>
      <p class="mt-2 text-xs text-gray-500">Ensure A ≥ A− ≥ B ≥ B− ≥ C ≥ Pass.</p>
    </section>

    <!-- Relative -->
    <section id="relSection" class="bg-white rounded-xl shadow p-5 hidden">
      <h3 class="text-base font-semibold mb-3">Relative buckets (percent → points)</h3>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
        <div><label class="block text-xs text-gray-600 mb-1">Top % → 10</label><input name="top10" type="number" min="0" max="100" value="10" class="w-full rounded-md border-gray-300 text-sm px-3 py-2"></div>
        <div><label class="block text-xs text-gray-600 mb-1">Next % → 9</label><input name="next15" type="number" min="0" max="100" value="15" class="w-full rounded-md border-gray-300 text-sm px-3 py-2"></div>
        <div><label class="block text-xs text-gray-600 mb-1">Next % → 8</label><input name="next25" type="number" min="0" max="100" value="25" class="w-full rounded-md border-gray-300 text-sm px-3 py-2"></div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-4">
        <div><label class="block text-xs text-gray-600 mb-1">Next % → 7</label><input name="next25b" type="number" min="0" max="100" value="25" class="w-full rounded-md border-gray-300 text-sm px-3 py-2"></div>
        <div><label class="block text-xs text-gray-600 mb-1">Next % → 6</label><input name="next15b" type="number" min="0" max="100" value="15" class="w-full rounded-md border-gray-300 text-sm px-3 py-2"></div>
        <div><label class="block text-xs text-gray-600 mb-1">Next % → 5</label><input name="next10" type="number" min="0" max="100" value="10" class="w-full rounded-md border-gray-300 text-sm px-3 py-2"></div>
      </div>

      <div class="flex justify-center">
        <div class="w-full sm:w-1/2">
          <label class="block text-xs text-gray-600 mb-1 text-center">Remainder → 4</label>
          <input name="rest_min" type="number" min="0" max="10" value="4" class="w-full rounded-md border-gray-300 text-sm px-3 py-2 text-center">
        </div>
      </div>

      <p class="mt-2 text-xs text-gray-500 text-center">Sum of listed buckets ≤ 100; remainder gets the minimum points.</p>
    </section>

    <!-- Actions -->
    <div class="bg-white rounded-xl shadow p-5 flex items-center gap-3">
      <button type="submit" class="inline-flex items-center rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium px-4 py-2">
        Save & Assign Grades
      </button>
      <a href="{% url 'grade_results' course.code %}?sem={{ semester }}" class="text-sm text-gray-700 hover:text-gray-900">View results</a>
    </div>
  </form>
</main>

<script>
  function togglePolicySections() {
    const mode = document.getElementById('mode').value;
    const absSec = document.getElementById('absSection');
    const relSec = document.getElementById('relSection');
    if (mode === 'REL') { absSec.classList.add('hidden'); relSec.classList.remove('hidden'); }
    else { relSec.classList.add('hidden'); absSec.classList.remove('hidden'); }
  }
  document.addEventListener('DOMContentLoaded', togglePolicySections);
</script>
</body>
</html>
