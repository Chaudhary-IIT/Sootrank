{% extends "faculty_base.html" %}
{% load static %}
{% block title %}Manage Attendance | Sootrank{% endblock %}
{% block nav_quick_active %} active{% endblock %}

{% block content %}
<div class="text-center mb-4">
  <h1 class="fs-3 fw-bold mb-1">Manage Attendance</h1>
  <p class="text-muted small mb-0">{{ course.name }} ({{ course.code }})</p>
</div>

<!-- Upload CSV Section -->
<div class="bg-white p-4 mb-4" style="border-radius: var(--radius); box-shadow: var(--shadow-subtle);">
  <h2 class="fs-5 fw-semibold mb-2"><i class="fa-solid fa-upload me-1"></i> Upload Attendance CSV</h2>
  <p class="small text-muted mb-3">
    Accepted format 1: <code>Roll No, Date1, Date2, ...</code> with <code>1/P</code> for present.<br>
    Accepted format 2: <code>Date, Roll Nos Present</code> with comma-separated rolls.
  </p>

  <form method="post" enctype="multipart/form-data" class="row g-3 align-items-end">
    {% csrf_token %}
    <div class="col-md-8 col-lg-6">
      <label class="form-label small fw-medium" for="attendanceFile">Select CSV File</label>
      <input type="file" name="attendance_file" id="attendanceFile" accept=".csv" class="form-control" required>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-success">
        <i class="fa-solid fa-file-arrow-up me-1"></i> Upload
      </button>
    </div>
  </form>
</div>

<!-- Manual Entry Table -->
<form method="post" class="bg-white" style="border-radius: var(--radius); box-shadow: var(--shadow-subtle); overflow: hidden;">
  {% csrf_token %}
  <div class="table-responsive">
    <table class="table table-bordered text-center align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th>Roll No</th>
          <th>Student Name</th>
          <th>Classes Attended</th>
          <th>Total Classes</th>
          <th>%</th>
        </tr>
      </thead>
      <tbody>
      {% for d in data %}
        <tr>
          <td class="fw-medium">{{ d.student.roll_no }}</td>
          <td>{{ d.student.first_name }} {{ d.student.last_name }}</td>
          <td><input type="number" min="0" name="attended_{{ d.student.id }}" value="{{ d.attended }}" class="form-control form-control-sm text-center" style="width: 90px;"></td>
          <td><input type="number" min="0" name="total_{{ d.student.id }}" value="{{ d.total }}" class="form-control form-control-sm text-center" style="width: 90px;"></td>
          <td><span class="fw-bold {% if d.percent < 75 %}text-danger{% else %}text-success{% endif %}">{{ d.percent }}%</span></td>
        </tr>
      {% empty %}
        <tr><td colspan="5" class="text-center text-muted p-5">No enrolled students found.</td></tr>
      {% endfor %}
      </tbody>
    </table>
  </div>

  {% if data %}
  <div class="p-3 text-end bg-light border-top">
    <button type="submit" class="btn btn-primary"><i class="bi bi-check-circle me-1"></i> Save Attendance</button>
  </div>
  {% endif %}
</form>


{% endblock %}
