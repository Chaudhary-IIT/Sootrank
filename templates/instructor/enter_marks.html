{% extends "faculty_base.html" %}

{% load dict_extras %}

{% block title %}Enter Marks — {{ course.code }}{% endblock %}

{% block nav_results_active %} active{% endblock %}

{% block content %}

<div class="text-center mb-4">
  <h1 class="fs-3 fw-bold mb-1">Enter Marks</h1>
  <p class="text-muted small mb-0">{{ course.code }} — {{ course.name }}</p>
</div>

<div class="bg-white p-4 p-md-5 mb-4" style="border-radius: var(--radius); box-shadow: var(--shadow-subtle);">
  <h2 class="fs-5 fw-semibold">Upload CSV/Excel Per Component</h2>
  <p class="small text-muted mb-3">
    Accepted: <code class="small">.csv, .xls, .xlsx</code> · Columns: <code class="small">roll_no, marks</code>
  </p>
  
  <form method="post" enctype="multipart/form-data" class="row g-3">
    {% csrf_token %}
    {% for comp in components %}
      <div class="col-12 col-md-6 col-lg-4">
        <label class="form-label small fw-medium">{{ comp.name }} (Max {{ comp.max_marks }})</label>
        <input class="form-control" type="file" name="component_csv_{{ comp.id }}"
               accept=".csv, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" />
      </div>
    {% endfor %}
    <div class="col-12 mt-4">
      <button type="submit" name="upload_component" value="1" class="btn btn-success">
        <i class="fa-solid fa-upload me-1"></i> Upload Selected Components
      </button>
    </div>
  </form>
</div>

<div class="bg-white p-4 p-md-5 mb-4" style="border-radius: var(--radius); box-shadow: var(--shadow-subtle);">
  <h2 class="fs-5 fw-semibold">Upload a Single File for All Components</h2>
  <p class="small text-muted mb-3">
    Include <code class="small">roll_no</code> and one column per component name (case-insensitive match).
  </p>
  
  <form method="post" enctype="multipart/form-data" class="row g-3 align-items-end">
    {% csrf_token %}
    <div class="col-12 col-md-8 col-lg-6">
      <label class="form-label small fw-medium" for="bulkFileId">Select Marks File (.csv / .xlsx)</label>
      <input class="form-control" type="file" name="bulk_file" id="bulkFileId"
             accept=".csv, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" required />
    </div>
    <div class="col-auto">
      <button type="submit" name="upload_all" value="1" class="btn btn-primary">
        <i class="fa-solid fa-file-arrow-up me-1"></i> Upload All Marks
      </button>
    </div>
  </form>
</div>

<div class="text-center">
  <a class="btn btn-outline-secondary" href="{% url 'course_marks_overview' course.id %}">
    <i class="fa-solid fa-chart-bar me-1"></i> View Marks Overview
  </a>
</div>

{% endblock %}


{% block extra_js %}
<script>
// This script seems to be from a different version of the page
// (it mentions #marksTable), but I'm keeping it in case
// you're using it elsewhere or plan to add the table back.
document.addEventListener("DOMContentLoaded", function() {
  function updateRowTotal(row){
    let sum = 0;
    row.querySelectorAll(".mark-input").forEach(input => {
      const v = parseFloat(input.value);
      if(!isNaN(v)) sum += v;
    });
    const tc = row.querySelector(".total-cell");
    if(tc) tc.textContent = sum.toFixed(2);
  }

  const marksTable = document.getElementById("marksTable");
  if (marksTable) {
    marksTable.querySelectorAll("tbody tr").forEach(row => {
      updateRowTotal(row);
      row.querySelectorAll(".mark-input").forEach(input => {
        input.addEventListener("input", () => updateRowTotal(row));
      });
    });
  }
});
</script>
{% endblock %}