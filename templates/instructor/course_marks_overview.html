{% extends "faculty_base.html" %}
{% block title %}Marks Overview ‚Äî {{ course.code }}{% endblock %}
{% block nav_results_active %} active{% endblock %}

{% block extra_css %}
<style>
  /* ...your same CSS... (UNCHANGED) ... */
</style>
{% endblock %}

{% block content %}
<div class="text-center mb-3">
  <h1 class="fs-3 fw-bold mb-1">Marks Overview</h1>
  <p class="text-muted small mb-0">{{ course.code }} ‚Äî {{ course.name }}</p>
</div>
<div class="text-end mb-3">
    <a href="{% url 'apply_grading_policy' course.id %}" class="btn btn-primary">
      <i class="bi bi-arrow-repeat me-1"></i>
      Apply Grading Policy & Update Grades
    </a>
  </div>

{% if policy %}
<div class="alert alert-info small text-start mb-3">
  <i class="fa-solid fa-scale-balanced me-1"></i>
  Current grading mode:
  <strong>
    {% if policy.mode == "REL" %}Relative{% else %}Absolute{% endif %}
  </strong>
</div>
{% endif %}

<div class="bg-white controls-panel" style="border-radius: var(--radius); box-shadow: var(--shadow-subtle);">
  <div class="row g-2 align-items-center">
    <div class="col-md-6">
      <div class="input-group">
        <span class="input-group-text">üîç</span>
        <input id="search" type="text" class="form-control" placeholder="Filter by Roll No or Name..." />
      </div>
    </div>
    <div class="col-md-6 text-md-end">
      <span class="small-muted">Click a mark to edit, <b>Enter</b> to save, <b>Esc</b> to cancel</span>
    </div>
  </div>

  
</div>

<div id="alert" class="alert d-none my-3" role="alert"></div>

<div class="marks-wrapper bg-white overflow-hidden mt-3">
  <div class="table-responsive">
    <table class="table table-bordered table-striped align-middle mb-0">

      <thead class="table-light sticky-actions">
        <tr>
          <th class="p-3">Roll No</th>
          <th class="p-3 student-name">Student</th>

          {% for comp in components %}
          <th class="p-3 cell-w">
            {{ comp.name }}<br/>
            <small class="text-muted">
              Max {{ comp.max_marks }} ¬∑ Wt {{ comp.weight|default_if_none:1 }}
            </small>
          </th>
          {% endfor %}

          <th class="p-3">Total<br><small class="text-muted">Max {{ max_total }}</small></th>

          {# ---------- CONDITIONAL % COLUMN ---------- #}
          {% if policy.mode == "ABS" %}
            <th class="p-3">%</th>
          {% endif %}

          {# ---------- CONDITIONAL PERCENTILE COLUMN ---------- #}
          {% if policy.mode == "REL" %}
            <th class="p-3">Percentile</th>
          {% endif %}

          <th class="p-3">Grade</th>
          <th class="p-3">Outcome</th>
        </tr>
      </thead>
              <tbody id="rows">
        {% for r in rows %}
        <tr data-student-id="{{ r.student.id }}">

          <!-- Roll No -->
          <td class="p-3 roll mono">{{ r.student.roll_no|upper }}</td>

          <!-- Student Name -->
          <td class="p-3 student-name"
              title="{{ r.student.first_name }} {{ r.student.last_name|default_if_none:'' }}">
            {{ r.student.first_name }} {{ r.student.last_name|default_if_none:'' }}
          </td>

          <!-- Components -->
          {% for p in r.pairs %}
          <td class="p-3 mono editable"
              data-component-id="{{ p.component_id }}"
              data-max="{{ p.max }}"
              data-weight="{{ p.component.weight|default_if_none:1 }}"
              data-value="{% if p.value is not None %}{{ p.value }}{% endif %}">
            {% if p.value is not None %}
              {{ p.value|floatformat:2 }}
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          {% endfor %}

          <!-- Total -->
          <td class="p-3 mono fw-semibold total-cell">
            {% if r.total is not None %}
              {{ r.total|floatformat:2 }}
            {% else %}
              ‚Äî
            {% endif %}
          </td>

          <!-- CONDITIONAL: % only in ABSOLUTE -->
          {% if policy.mode == "ABS" %}
          <td class="p-3 mono percentage-cell">
            {% if r.percentage is not None %}
              {{ r.percentage|floatformat:2 }}
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          {% endif %}

          <!-- CONDITIONAL: Percentile only in RELATIVE -->
          {% if policy.mode == "REL" %}
          <td class="p-3 mono percentile-cell">
            {% if r.percentile is not None %}
              {{ r.percentile|floatformat:2 }}
            {% else %}
              ‚Äî
            {% endif %}
          </td>
          {% endif %}

          <!-- Grade -->
          <td class="p-3 grade-cell" data-grade>
            {{ r.grade|default_if_none:"‚Äî" }}
          </td>

          <!-- Outcome -->
          <td class="p-3 outcome-cell" data-outcome>
            {% if r.outcome == 'PAS' %}
              <span class="outcome-pass">Pass</span>
            {% elif r.outcome == 'FAI' %}
              <span class="outcome-fail">Fail</span>
            {% else %}
              ‚Äî
            {% endif %}
          </td>

        </tr>
        {% endfor %}
      </tbody>

    </table>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', () => {

  /* -----------------------
     SEARCH FILTER
     ----------------------- */
  const input = document.getElementById('search');
  const alertBox = document.getElementById('alert');

  function showAlert(kind, msg){
    alertBox.className = `alert alert-${kind} my-3`;
    alertBox.textContent = msg;
    alertBox.classList.remove('d-none');
    clearTimeout(showAlert._t);
    showAlert._t = setTimeout(()=>alertBox.classList.add('d-none'), 2500);
  }

  if (input) {
    input.addEventListener('input', function(){
      const q = this.value.toLowerCase();
      document.querySelectorAll('#rows tr').forEach(tr => {
        tr.style.display = tr.innerText.toLowerCase().includes(q) ? '' : 'none';
      });
    });
  }

  /* -----------------------
     EDITABLE CELLS
     ----------------------- */
  let editing = null;

  document.querySelectorAll('#rows td.editable').forEach(td => {
    td.addEventListener('click', () => startEdit(td));
  });

  function startEdit(td){
    if (editing) endEdit(false);

    const current = td.dataset.value || "";
    const max = td.dataset.max;
    const input = document.createElement('input');

    input.type = 'number';
    input.step = '0.01';
    input.value = current;
    input.min = "0";
    if (max) input.max = max;
    input.className = 'form-control form-control-sm';

    td.classList.add('editing');
    td.innerHTML = '';
    td.appendChild(input);
    input.focus();
    input.select();

    editing = {td, initial: current};

    input.addEventListener('keydown', e => {
      if (e.key === 'Enter') endEdit(true);
      if (e.key === 'Escape') endEdit(false);
    });

    input.addEventListener('blur', ()=> endEdit(true));
  }

  function endEdit(commit){
    if (!editing) return;

    const td = editing.td;
    const initial = editing.initial;
    const input = td.querySelector('input');

    if (!input){
      editing = null;
      return;
    }

    const newVal = input.value.trim();
    td.classList.remove('editing');

    if (!commit || newVal === initial){
      td.innerHTML = renderCell(initial);
      editing = null;
      return;
    }

    const max = parseFloat(td.dataset.max);
    const num = parseFloat(newVal);

    if (newVal !== "" && (isNaN(num) || num < 0 || num > max)){
      showAlert("danger", `Invalid value. Expected 0 to ${max}`);
      td.innerHTML = renderCell(initial);
      editing = null;
      return;
    }

    editing = null;

    const tr = td.closest("tr");
    const studentId = tr.dataset.studentId;
    const componentId = td.dataset.componentId;
    const csrftoken = getCookie("csrftoken");

    const formData = new FormData();
    formData.append("student_id", studentId);
    formData.append("component_id", componentId);
    formData.append("value", newVal);

    td.innerHTML = renderCell(newVal);
    td.dataset.value = newVal;

    recomputeRow(tr);

    fetch("{% url 'update_mark_cell' course.id %}", {
      method: "POST",
      headers: {"X-CSRFToken": csrftoken},
      body: formData
    })
    .then(r => r.json())
    .then(data => {
      if (data.ok){
        td.dataset.value = data.value || "";
        td.innerHTML = renderCell(td.dataset.value);
        recomputeRow(tr);
        showAlert("success", "Saved");
      }
      else {
        showAlert("danger", data.error || "Error");
        td.dataset.value = initial;
        td.innerHTML = renderCell(initial);
        recomputeRow(tr);
      }
    })
    .catch(() => {
      showAlert("danger", "Network error");
      td.dataset.value = initial;
      td.innerHTML = renderCell(initial);
      recomputeRow(tr);
    });
  }

  /* -----------------------
     RENDER CELL
     ----------------------- */
  function renderCell(val){
    if (val === "" || val === null || typeof val === "undefined") return "‚Äî";
    const num = parseFloat(val);
    return isNaN(num) ? "‚Äî" : num.toFixed(2);
  }

  /* -----------------------
     RECOMPUTE ROW
     ----------------------- */
  function recomputeRow(tr){
    let weighted = 0, weightSum = 0;

    tr.querySelectorAll("td.editable").forEach(td => {
      const v = parseFloat(td.dataset.value || "");
      const max = parseFloat(td.dataset.max || "");
      const w = parseFloat(td.dataset.weight || "1");

      if (!isNaN(w)) weightSum += w;
      if (!isNaN(v) && !isNaN(max) && max > 0 && !isNaN(w)){
        weighted += (v / max) * w;
      }
    });

    const totalCell = tr.querySelector('.total-cell');
    totalCell.textContent = isNaN(weighted) ? "‚Äî" : weighted.toFixed(2);

    /* ------------------------------------------
       ABSOLUTE MODE: Only update %
       ------------------------------------------ */
    {% if policy.mode == "ABS" %}
    const percentCell = tr.querySelector('.percentage-cell');
    if (percentCell){
      const pct = weightSum > 0 ? (weighted / weightSum) * 100 : NaN;
      percentCell.textContent = isNaN(pct) ? "‚Äî" : pct.toFixed(2);
    }
    {% endif %}

    /* ------------------------------------------
       RELATIVE MODE: Only update percentile
       ------------------------------------------ */
    {% if policy.mode == "REL" %}
    // Collect all totals
    const totals = [];
    document.querySelectorAll("#rows tr").forEach(row => {
      const tcell = row.querySelector(".total-cell");
      const val = parseFloat(tcell ? tcell.textContent : "");
      totals.push(isNaN(val) ? 0 : val);
    });

    totals.sort((a,b)=>a-b);
    const n = totals.length;

    const val = parseFloat(totalCell.textContent);
    let pctile = 100;

    if (n > 1){
      let lo = 0, hi = n;
      while (lo < hi){
        const mid = (lo + hi) >> 1;
        if (totals[mid] < val) lo = mid + 1;
        else hi = mid;
      }
      pctile = lo / (n - 1) * 100;
    }

    const pcell = tr.querySelector(".percentile-cell");
    if (pcell) pcell.textContent = pctile.toFixed(2);
    {% endif %}

    /* -------------- Grade + Outcome --------------- */
    // Backend recomputes actual grade, frontend only shows temporary
  }

  /* -----------------------
     CSRF HELPER
     ----------------------- */
  function getCookie(name){
    const cookies = document.cookie.split(";").map(c => c.trim());
    for (let c of cookies){
      if (c.startsWith(name + "="))
        return decodeURIComponent(c.split("=")[1]);
    }
    return null;
  }

  /* INITIAL RECOMPUTE */
  document.querySelectorAll("#rows tr").forEach(tr => recomputeRow(tr));
});
</script>
{% endblock %}
