{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Course Selection Status</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="min-h-screen bg-gray-100 flex items-start justify-center py-10">
  <div class="w-[1150px]">
    {% if messages %}
      <div class="mb-3">
        {% for message in messages %}
          <div class="alert alert-{{ message.tags }} mb-2" role="alert">{{ message }}</div>
        {% endfor %}
      </div>
    {% endif %}

    <!-- Header -->
    <div class="mb-5 flex items-center justify-between">
      <div>
        <h1 class="text-3xl font-bold">Course Summary</h1>
        <p class="text-sm text-gray-600 mt-1">
          Review the current pre-registration status and modify course mode (Regular, Pass/Fail, or Audit).
        </p>
      </div>
      <span class="inline-flex items-center rounded-full bg-blue-100 text-blue-800 text-xs font-medium px-3 py-1">
        Semester {{ sem_display }}
      </span>
    </div>

    <!-- Info -->
    <div class="mb-3 text-sm text-gray-700">
      Pass/Fail credits used: <span class="font-semibold" id="pfUsed">{{ pf_total }}</span> / 9 overall  
      (Max 6 PF credits allowed per semester)
    </div>
    <div class="mb-4 text-xs text-gray-500">
      Mode changes are staged locally until "Apply Changes" is pressed. Approved courses cannot be modified.
    </div>

    <!-- Card -->
    <div class="bg-white rounded-2xl shadow">
      <div class="rounded-2xl overflow-x-auto">
        <table class="w-full text-left border-collapse table-fixed min-w-[1050px]">
          <thead>
            <tr class="bg-gray-50 text-gray-700">
              <th class="px-5 py-3 text-sm font-semibold w-24">Code</th>
              <th class="px-5 py-3 text-sm font-semibold w-[260px]">Course Name</th>
              <th class="px-5 py-3 text-sm font-semibold w-[220px]">Instructor</th>
              <th class="px-5 py-3 text-sm font-semibold w-20">Type</th>
              <th class="px-5 py-3 text-sm font-semibold w-12">Slot</th>
              <th class="px-5 py-3 text-sm font-semibold w-16">Credits</th>
              <th class="px-5 py-3 text-sm font-semibold w-20">LTPC</th>
              <th class="px-5 py-3 text-sm font-semibold min-w-[140px]">Status</th>
              <th class="px-5 py-3 text-sm font-semibold min-w-[160px]">Course Mode</th>
            </tr>
          </thead>

          <tbody class="text-gray-900">
            {% if enrollments %}
              {% for sc in enrollments %}
                {% with course=sc.course %}
                <tr class="{% cycle '' 'bg-gray-50' %} border-t" 
                    data-sc-id="{{ sc.id }}"
                    data-credits="{{ course.credits }}"
                    {% if sc.status == 'ENR' %}data-approved="1"{% else %}data-approved="0"{% endif %}>

                  <td class="px-5 py-3 whitespace-nowrap">{{ course.code }}</td>
                  <td class="px-5 py-3 whitespace-normal break-words">{{ course.name }}</td>

                  <!-- Instructor -->
                  <td class="px-5 py-3 whitespace-normal break-words">
                    {% with facs=course.faculties.all %}
                      {% if facs %}
                        {% for f in facs %}
                          {{ f.first_name }}{% if f.last_name %} {{ f.last_name }}{% endif %}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                      {% else %}
                        —
                      {% endif %}
                    {% endwith %}
                  </td>

                  <!-- Type -->
                  <td class="px-5 py-3 whitespace-nowrap">
                    {% if sc.type and sc.type != "ALL" %}
                      {{ sc.type }}
                    {% else %}
                      {% with cb=course.coursebranch_set.all %}
                        {% if cb and cb.0 and cb.0.categories.all %}
                          {{ cb.0.categories.all.0.code }}
                        {% else %}
                          —
                        {% endif %}
                      {% endwith %}
                    {% endif %}
                  </td>

                  <td class="px-5 py-3 whitespace-nowrap">{{ course.slot }}</td>
                  <td class="px-5 py-3 whitespace-nowrap">{{ course.credits }}</td>
                  <td class="px-5 py-3 whitespace-nowrap">{{ course.LTPC }}</td>

                  <!-- Status -->
                  <td class="px-5 py-3">
                    {% if sc.status == "ENR" %}
                      <span class="inline-flex items-center rounded-full bg-green-100 text-green-800 text-xs font-medium px-3 py-1">Approved</span>
                    {% elif sc.status == "PND" %}
                      <span class="inline-flex items-center rounded-full bg-amber-100 text-amber-800 text-xs font-medium px-3 py-1">Pending</span>
                    {% elif sc.status == "DRP" %}
                      <span class="inline-flex items-center rounded-full bg-red-100 text-red-700 text-xs font-medium px-3 py-1">Rejected</span>
                    {% else %}
                      <span class="inline-flex items-center rounded-full bg-gray-100 text-gray-700 text-xs font-medium px-3 py-1">{{ sc.get_status_display|default:"—" }}</span>
                    {% endif %}
                  </td>

                  <!-- Dropdown -->
                  <td class="px-5 py-3">
                    <select class="mode-dropdown w-full px-3 py-1 rounded border border-gray-300 text-sm bg-white"
                            data-sc-id="{{ sc.id }}"
                            data-credits="{{ course.credits }}"
                            data-approved="{% if sc.status == 'ENR' %}1{% else %}0{% endif %}">
                      <option value="REG" {% if sc.course_mode == 'REG' %}selected{% endif %}>Regular</option>
                      <option value="PF" {% if sc.course_mode == 'PF' %}selected{% endif %}>Pass/Fail</option>
                      <option value="AUD" {% if sc.course_mode == 'AUD' %}selected{% endif %}>Audit</option>
                    </select>
                    <div class="text-[11px] mt-1 text-gray-600" data-mode-hint></div>
                  </td>

                </tr>
                {% endwith %}
              {% endfor %}
            {% else %}
              <tr class="border-t">
                <td class="px-5 py-6 text-center text-gray-500" colspan="9">
                  No pre-registrations yet for this semester.
                </td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <!-- Footer -->
      <div class="flex items-center justify-between px-5 py-4">
        <div class="text-sm">
          Staged changes: <span id="stagedCount" class="font-semibold">0</span>
        </div>
        <div class="flex gap-3">
          <a href="{% url 'students_dashboard' %}" class="px-5 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700">Home</a>
          <button id="applyBtn" type="button"
                  class="px-5 py-2 rounded-lg bg-gray-800 text-white hover:bg-black disabled:opacity-50 disabled:cursor-not-allowed"
                  disabled>
            Apply Changes
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal" class="fixed inset-0 hidden justify-center items-center bg-black/60 z-50 pointer-events-none">
    <div class="bg-white rounded-2xl shadow-lg w-[520px] p-6 pointer-events-auto">
      <h2 class="text-xl font-bold mb-2">Confirm Mode Update</h2>
      <p class="text-red-600 text-sm mb-4">
        Changes to course mode (Regular / Pass-Fail / Audit) cannot be undone. Proceed?
      </p>
      <div class="border rounded bg-gray-50 p-3 text-sm mb-4 max-h-56 overflow-auto">
        <div id="changeList"></div>
      </div>
      <div class="flex justify-between">
        <button id="cancelModal" type="button" class="px-4 py-2 rounded bg-gray-300 text-gray-800 hover:bg-gray-400">Back</button>
        <form id="applyForm" method="post" action="{% url 'apply_mode_changes' %}">
          {% csrf_token %}
          <input type="hidden" name="payload" id="changesPayload">
          <button type="submit" class="px-5 py-2 rounded bg-green-600 text-white hover:bg-green-700">Apply</button>
        </form>
      </div>
    </div>
  </div>

  <script>
    const modal = document.getElementById("confirmModal");
    const staged = {};
    let pfUsed = parseInt(document.getElementById("pfUsed").textContent || "0", 10) || 0;

    function refreshStatus() {
      const count = Object.keys(staged).length;
      document.getElementById("stagedCount").textContent = count;
      document.getElementById("applyBtn").disabled = count === 0;
    }

    document.querySelectorAll(".mode-dropdown").forEach(sel => {
      sel.addEventListener("change", e => {
        const scId = e.target.getAttribute("data-sc-id");
        const credits = parseInt(e.target.getAttribute("data-credits") || "0", 10);
        const approved = e.target.getAttribute("data-approved") === "1";
        const row = e.target.closest("tr[data-sc-id]");
        const hint = row.querySelector("[data-mode-hint]");
        const newMode = e.target.value;

        if (approved) {
          e.target.value = "REG";
          if (hint) hint.textContent = "Approved; cannot change mode.";
          return;
        }

        staged[scId] = { new_mode: newMode, credits: credits, code: row.children[0].textContent.trim() };
        refreshStatus();
      });
    });

    document.getElementById("applyBtn").addEventListener("click", () => {
      const entries = Object.entries(staged);
      if (!entries.length) return;

      const list = document.getElementById("changeList");
      list.innerHTML = "";

      let pfPreview = pfUsed;
      entries.forEach(([scId, info]) => {
        const div = document.createElement("div");
        div.textContent = `${info.code}: → ${info.new_mode}`;
        list.appendChild(div);
        if (info.new_mode === "PF") pfPreview += info.credits;
      });

      const totalLine = document.createElement("div");
      totalLine.className = "mt-2 text-gray-700";
      totalLine.textContent = `Pass/Fail total after update: ${pfPreview} / 9`;
      list.appendChild(totalLine);

      const payload = entries.map(([scId, info]) => ({ sc_id: scId, new_mode: info.new_mode }));
      document.getElementById("changesPayload").value = JSON.stringify({ changes: payload });

      modal.classList.remove("hidden");
      modal.classList.add("flex");
      modal.classList.remove("pointer-events-none");
    });

    document.getElementById("cancelModal").addEventListener("click", () => {
      modal.classList.add("hidden");
      modal.classList.add("pointer-events-none");
    });
  </script>
</body>
</html>
