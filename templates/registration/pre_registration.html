{% extends "student_base.html" %}
{% load dict_extras %}
{% block title %}Course Pre-Registration{% endblock %}
{% block nav_registration_active %} active{% endblock %}

{% block content %}
<div class="w-100">
  {% if messages %}
  <div class="container mt-3" style="max-width:700px;">
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  </div>
{% endif %}

  <!-- Header -->
  <div class="mb-4 d-flex align-items-center justify-content-between">
    <div>
      <h1 class="h3 fw-bold mb-1">Course Pre-Registration</h1>
      <p class="text-muted small mb-0">Choose one course per slot for this semester.</p>
    </div>
    <span class="badge rounded-pill text-bg-primary bg-opacity-10 text-primary border border-primary-subtle">
      Semester {{ computed_semester }}
    </span>
  </div>

  <!-- ðŸ”¹ New cycle info -->
  {% if new_cycle %}
  <div class="alert alert-info small py-2 mb-3">
    <i class="fa-solid fa-rotate-left me-2"></i>
    A new pre-registration cycle has started. Previous semester data has been archived.
  </div>
  {% endif %}

  <!-- Window info -->
  <p class="mb-2 {% if window_open %}text-success{% else %}text-danger{% endif %}">
    {% if window_open %}Pre-registration is open.{% else %}Pre-registration window is closed.{% endif %}
  </p>
  <p class="text-muted small">Selections are validated on submit. Approved slots are locked and cannot be changed.</p>

  <div class="bg-white rounded-3 shadow-sm border">
    <form id="courseForm" method="post" action="{% url 'submit_preregistration' %}" class="p-4">
      {% csrf_token %}
      <input type="hidden" name="payload" id="payloadInput" />

      <!-- Slots grid -->
      <div class="row g-3">
        {% for slot in slots %}
        <div class="col-12 col-md-6 col-lg-4">
          <div class="d-flex flex-column" data-slot="{{ slot }}">
            <label class="fw-semibold mb-1">Slot-{{ slot }}</label>

            <!-- Category select -->
            <select id="slot-{{ slot }}-cat" name="slot-{{ slot }}-cat"
                    class="form-select form-select-sm slot-cat"
                    data-slot="{{ slot }}" {% if slot in locked_slots %}disabled{% endif %}>
              <option value="">Select category</option>
              <option value="ALL">All courses (Slot {{ slot }})</option>
              {% for c in categories %}
                <option value="{{ c.code }}">{{ c.code }} â€” {{ c.label }}</option>
              {% endfor %}
            </select>

            <!-- Course select -->
            <select id="slot-{{ slot }}-course" name="slot-{{ slot }}-course"
                    class="form-select form-select-sm mt-2 slot-course"
                    data-slot="{{ slot }}"
                    {% if slot in locked_slots %}disabled{% elif not preselected_by_slot|get_item:slot %}disabled{% endif %}>
              {% if preselected_by_slot|get_item:slot %}
                <option value="">Select a course</option>
              {% else %}
                <option value="">Select a category first</option>
              {% endif %}

              <!-- Hidden: ALL options -->
              {% for c in categories %}
                {% with cat_code=c.code %}
                  {% for course in slot_map|get_item:slot|get_item:cat_code %}
                    <option value="{{ course.code }}" data-credits="{{ course.credits }}"
                            data-category="ALL" data-cat="ALL" class="d-none all-slot-{{ slot }}">
                      {{ course.name }} ({{ course.code }}) - {{ course.credits }} credits â€¢ {{ cat_code }}
                    </option>
                  {% endfor %}
                {% endwith %}
              {% endfor %}

              <!-- Hidden: category-specific -->
              {% for c in categories %}
                {% with cat_code=c.code %}
                  {% for course in slot_map|get_item:slot|get_item:cat_code %}
                    {% if course.cb_for_branch and course.cb_for_branch.0 %}
                      {% with cat=course.cb_for_branch.0.category %}
                        <option value="{{ course.code }}" data-credits="{{ course.credits }}"
                                data-category="{{ cat }}" data-cat="{{ cat_code }}" class="d-none">
                          {{ course.name }} ({{ course.code }}) - {{ course.credits }} credits â€¢ {{ cat }}
                        </option>
                      {% endwith %}
                    {% else %}
                      <option value="{{ course.code }}" data-credits="{{ course.credits }}"
                              data-category="{{ cat_code }}" data-cat="{{ cat_code }}" class="d-none">
                        {{ course.name }} ({{ course.code }}) - {{ course.credits }} credits â€¢ {{ cat_code }}
                      </option>
                    {% endif %}
                  {% endfor %}
                {% endwith %}
              {% endfor %}
            </select>

            <div class="cat-badge small mt-1 {% if slot in locked_slots %}text-success{% else %}text-muted{% endif %}">
              {% if slot in locked_slots %}Approved; selection locked{% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Totals -->
      <div class="d-flex align-items-center justify-content-between mt-4">
        <p class="fw-semibold m-0">
          Total Credits:
          <span id="totalCredits" class="text-success">0</span>
        </p>
        <p id="creditError" class="text-danger small m-0 d-none"></p>
      </div>

      <hr class="my-4" />

      <!-- Actions -->
      <div class="d-flex align-items-center justify-content-between">
        <a href="{% url 'students_dashboard' %}" class="btn btn-success btn-sm">Home</a>
        <div class="d-flex gap-2">
          <button type="button" id="resetBtn" class="btn btn-outline-secondary btn-sm"
                  {% if not window_open %}disabled{% endif %}>Reset</button>
          <button type="submit" class="btn btn-dark btn-sm"
                  {% if not window_open %}disabled{% endif %}>
            {% if preselected_by_slot %}Update{% else %}Submit{% endif %}
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Confirmation Modal -->
<div id="popup" class="position-fixed top-0 start-0 end-0 bottom-0 d-none justify-content-center align-items-center bg-black bg-opacity-50 z-3">
  <div class="bg-white rounded-3 shadow-lg" style="width: 420px;">
    <div class="p-4">
      <h2 class="h5 fw-bold mb-2">Confirm {% if preselected_by_slot %}Update{% else %}Submission{% endif %}</h2>
      <p class="text-danger small mb-4">
        You will not be able to edit your course selection for this semester after this when the window closes.
        Are you sure you'd like to proceed?
      </p>
      <div class="d-flex justify-content-between">
        <button id="backBtn" class="btn btn-secondary btn-sm">Back</button>
        <button id="proceedBtn" class="btn btn-success btn-sm">Proceed</button>
      </div>
    </div>
  </div>
</div>

<!-- JSON data -->
{{ slot_map_json|json_script:"slot-map-data" }}
{{ preselected_by_slot|json_script:"preselected-data" }}
{{ locked_slots|json_script:"locked-slots-data" }}

<script>
  setTimeout(function () {
            document.querySelectorAll('.alert').forEach(function (alert) {
                var bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 4000);
  const minCredit = {{ min_credit|default_if_none:0 }};
  const maxCredit = {{ max_credit|default_if_none:999 }};
  const preselected = JSON.parse(document.getElementById("preselected-data").textContent || "{}");
  const lockedSlots = JSON.parse(document.getElementById("locked-slots-data").textContent || "[]");
  const slotMapJson = JSON.parse(document.getElementById("slot-map-data").textContent || "{}");

  const slotCredits = {};
  Object.keys(slotMapJson || {}).forEach(slot => {
    slotCredits[slot] = {};
    const byCat = slotMapJson[slot] || {};
    Object.keys(byCat).forEach(cat => {
      (byCat[cat] || []).forEach(course => {
        if (course && course.code)
          slotCredits[slot][course.code] = parseInt(course.credits || 0, 10) || 0;
      });
    });
  });

  function updateCredits() {
    let total = 0;
    document.querySelectorAll('div[data-slot]').forEach(wrap => {
      const slot = wrap.dataset.slot;
      const isLocked = lockedSlots.includes(slot);
      if (isLocked) {
        const code = preselected[slot];
        const cr = (slotCredits[slot] && code) ? (slotCredits[slot][code] || 0) : 0;
        total += cr;
      } else {
        const sel = wrap.querySelector('.slot-course');
        if (!sel || sel.disabled) return;
        const opt = sel.options[sel.selectedIndex];
        if (opt && opt.value) total += parseInt(opt.dataset.credits || '0', 10);
      }
    });
    document.getElementById("totalCredits").textContent = total;
    const err = document.getElementById("creditError");
    if (total < minCredit) { err.textContent = `Minimum ${minCredit} credits required`; err.classList.remove("d-none"); }
    else if (total > maxCredit) { err.textContent = `Maximum ${maxCredit} credits allowed`; err.classList.remove("d-none"); }
    else err.classList.add("d-none");
  }

  function onCategoryChange(catSel) {
    const slot = catSel.dataset.slot;
    const courseSel = document.getElementById(`slot-${slot}-course`);
    const chosenCat = catSel.value;
    if (lockedSlots.includes(slot)) return;

    // Reset course select
    courseSel.innerHTML = "";
    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = chosenCat ? "Select a course" : "Select a category first";
    courseSel.appendChild(placeholder);

    // Build selector for hidden options
    let nodeList;
    if (chosenCat === "ALL") {
      nodeList = document.querySelectorAll(`.all-slot-${slot}`);
    } else if (chosenCat) {
      nodeList = document.querySelectorAll(`#slot-${slot}-course-template option[data-cat="${chosenCat}"]`);
    } else {
      nodeList = [];
    }

    // If no options available, show "no courses" message and keep disabled
    if (!nodeList || nodeList.length === 0) {
      const noOpt = document.createElement("option");
      noOpt.value = "";
      noOpt.textContent = "No courses available for the selected category";
      noOpt.disabled = true;
      noOpt.selected = true;
      courseSel.appendChild(noOpt);
      courseSel.disabled = true;
    } else {
      // Populate actual options
      nodeList.forEach((opt) => {
        const clone = opt.cloneNode(true);
        clone.classList.remove("d-none");
        courseSel.appendChild(clone);
      });
      courseSel.disabled = false;

      // Apply preselected if exists
      const selectedCode = preselected[slot];
      if (selectedCode) {
        const idx = Array.from(courseSel.options).findIndex(o => o.value === selectedCode);
        if (idx >= 0) courseSel.selectedIndex = idx;
      }
    }

    const badge = courseSel.parentElement.querySelector(".cat-badge");
    badge.textContent = chosenCat ? (chosenCat === "ALL" ? "All categories" : `Category: ${chosenCat}`) : "";
    updateCredits();
  }

  function wireSlots() {
    document.querySelectorAll(".slot-course").forEach(sel => {
      const slot = sel.dataset.slot;
      const tmpl = document.createElement("select");
      tmpl.id = `slot-${slot}-course-template`;
      tmpl.className = "d-none";
      const opts = Array.from(sel.querySelectorAll("option.d-none, option[data-cat]"));
      opts.forEach(o => tmpl.appendChild(o));
      sel.parentElement.insertBefore(tmpl, sel.nextSibling);

      if (lockedSlots.includes(slot)) { sel.disabled = true; return; }

      const selectedCode = preselected[slot];
      if (selectedCode) {
        const allOpts = tmpl.querySelectorAll("option");
        let catForCourse = "";
        allOpts.forEach(o => { if (o.value === selectedCode && !catForCourse) catForCourse = o.dataset.cat || ""; });
        const catSel = document.getElementById(`slot-${slot}-cat`);
        // If course's category was removed server-side (passed filter), don't auto-select broken preselection
        if (catForCourse) {
          catSel.value = catForCourse || "ALL";
          onCategoryChange(catSel);
        } else {
          // show default empty because preselected course no longer exists in options
          sel.innerHTML = '<option value="">Select a category first</option>';
          sel.disabled = true;
        }
      } else {
        sel.innerHTML = '<option value="">Select a category first</option>';
        sel.disabled = true;
      }
    });
    document.querySelectorAll(".slot-cat").forEach(catSel => catSel.addEventListener("change", () => onCategoryChange(catSel)));
  }

  function collectSelections() {
    const selections = [];
    document.querySelectorAll(".slot-course").forEach(sel => {
      if (sel.disabled) return;
      const opt = sel.options[sel.selectedIndex];
      if (opt && opt.value) {
        selections.push({
          slot: sel.dataset.slot,
          course_code: opt.value,
          category: opt.dataset.category || opt.dataset.cat || "",
          credits: parseInt(opt.dataset.credits || "0", 10) || 0
        });
      }
    });
    return selections;
  }

  document.getElementById("resetBtn").addEventListener("click", () => {
    document.querySelectorAll(".slot-cat").forEach(sel => sel.value = "");
    document.querySelectorAll(".slot-course").forEach(sel => {
      if (lockedSlots.includes(sel.dataset.slot)) return;
      sel.innerHTML = '<option value="">Select a category first</option>';
      sel.disabled = true;
      const badge = sel.parentElement.querySelector(".cat-badge");
      if (badge) badge.textContent = "";
    });
    updateCredits();
  });

  document.getElementById("courseForm").addEventListener("submit", e => {
    e.preventDefault();
    if (!{% if window_open %}true{% else %}false{% endif %}) return;
    const total = parseInt(document.getElementById("totalCredits").textContent, 10);
    if (total >= minCredit && total <= maxCredit) {
      const payload = { semester: {{ computed_semester }}, selections: collectSelections() };
      document.getElementById("payloadInput").value = JSON.stringify(payload);
      const m = document.getElementById("popup");
      m.classList.remove("d-none"); m.classList.add("d-flex");
    }
  });

  document.getElementById("backBtn").addEventListener("click", () => document.getElementById("popup").classList.add("d-none"));
  document.getElementById("proceedBtn").addEventListener("click", () => {
    document.getElementById("popup").classList.add("d-none");
    document.getElementById("courseForm").submit();
  });

  document.querySelectorAll(".slot-course").forEach(sel => sel.addEventListener("change", updateCredits));
  wireSlots(); updateCredits();
</script>
{% endblock %}
